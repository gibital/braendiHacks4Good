<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scheduling Application</title>
  <!-- Bootstrap CSS from CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding-top: 20px; }
    .container { max-width: 1000px; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Employee Scheduling Setup</h1>
  <form id="scheduleForm" method="post" action="/">
    <!-- Mode Selection -->
    <div class="form-group">
      <label>Data Mode:</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="mode" id="mode_sample" value="sample">
        <label class="form-check-label" for="mode_sample">Sample Data</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="mode" id="mode_manual" value="manual" checked>
        <label class="form-check-label" for="mode_manual">Real Data</label>
      </div>
    </div>
    <div class="form-group">
      <label for="filename_prefix">Output Filename Prefix</label>
      <input type="text" class="form-control" id="filename_prefix" name="filename_prefix" placeholder="my_schedule">
    </div>
    <!-- Employee Table (only for Real Data) -->
    <div id="employeeSection">
      <h3>Employees</h3>
      <table class="table table-bordered" id="employeesTable">
        <thead>
          <tr>
            <th>Employee Name</th>
            <th>Multiplier</th>
            <th>Target Hours</th>
            <th>Regular Unavailable Days</th>
            <th>Individual Unavailable Days</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <button type="button" class="btn btn-secondary" id="addEmployeeBtn">Add Employee</button>
      <div class="mt-3">
        <h4>Aggregate Target Hours: <span id="aggregateTarget">0.0</span></h4>
        <div id="aggregateFeedback" class="alert" role="alert" style="display: none;"></div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Generate Schedule & Download XLSX</button>
  </form>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const BASE_HOURS = 420;
  const LOWER_THRESHOLD = 1850;
  const UPPER_THRESHOLD = 2000;
  const dayMapping = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  let employeeCount = 0;

  function updateRowTargetHours(row) {
    const multiplierInput = row.querySelector('.multiplier');
    const targetHoursCell = row.querySelector('.targetHours');
    let multiplier = parseFloat(multiplierInput.value);
    if (isNaN(multiplier)) multiplier = 0;
    targetHoursCell.innerText = (BASE_HOURS * multiplier).toFixed(1);
    updateAggregate();
  }

  function updateAggregate() {
    let total = 0;
    const rows = document.querySelectorAll('#employeesTable tbody tr');
    rows.forEach(row => {
      const multiplierInput = row.querySelector('.multiplier');
      let multiplier = parseFloat(multiplierInput.value);
      if (!isNaN(multiplier)) {
        total += BASE_HOURS * multiplier;
      }
    });
    document.getElementById('aggregateTarget').innerText = total.toFixed(1);
    const feedbackDiv = document.getElementById('aggregateFeedback');
    if (total < LOWER_THRESHOLD) {
      feedbackDiv.style.display = 'block';
      feedbackDiv.className = 'alert alert-warning';
      feedbackDiv.innerText = "Aggregate target hours are below the lower threshold. Consider adding more employees.";
    } else if (total > UPPER_THRESHOLD) {
      feedbackDiv.style.display = 'block';
      feedbackDiv.className = 'alert alert-warning';
      feedbackDiv.innerText = "Aggregate target hours exceed the upper threshold. Consider removing some employees.";
    } else {
      feedbackDiv.style.display = 'block';
      feedbackDiv.className = 'alert alert-success';
      feedbackDiv.innerText = "Aggregate target hours are within the acceptable range.";
    }
  }

  function addEmployeeRow(name="", multiplier="0.35", regularUnavailable="", individualUnavailable="") {
    employeeCount++;
    const tbody = document.querySelector('#employeesTable tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" class="form-control employeeName" name="employee_names[]" value="${name}" required></td>
      <td><input type="number" step="0.05" min="0.35" class="form-control multiplier" name="multipliers[]" value="${multiplier}" required></td>
      <td class="targetHours">0.0</td>
      <td>
        <select multiple class="form-control regularUnavailable" name="regular_unavailable_${employeeCount}[]">
          <option value="0">Monday</option>
          <option value="1">Tuesday</option>
          <option value="2">Wednesday</option>
          <option value="3">Thursday</option>
          <option value="4">Friday</option>
          <option value="5">Saturday</option>
          <option value="6">Sunday</option>
        </select>
      </td>
      <td><input type="text" class="form-control individualUnavailable" name="individual_unavailable_${employeeCount}" placeholder="e.g., 1,5,10"></td>
      <td><button type="button" class="btn btn-danger removeEmployeeBtn">Remove</button></td>
    `;
    row.querySelector('.multiplier').addEventListener('input', () => updateRowTargetHours(row));
    row.querySelector('.removeEmployeeBtn').addEventListener('click', () => {
      row.remove();
      updateAggregate();
    });
    tbody.appendChild(row);
    updateRowTargetHours(row);
  }

  document.getElementById('addEmployeeBtn').addEventListener('click', () => {
    addEmployeeRow();
  });

  // Toggle between Sample and Real Data modes.
  document.querySelectorAll('input[name="mode"]').forEach(radio => {
    radio.addEventListener('change', function(){
      if (this.value === 'sample') {
        document.getElementById('employeeSection').style.display = 'none';
      } else {
        document.getElementById('employeeSection').style.display = 'block';
      }
    });
  });

  // Initialize with Real Data mode and one employee row.
  window.onload = function() {
    // Ensure manual mode is selected.
    document.getElementById('mode_manual').checked = true;
    document.getElementById('employeeSection').style.display = 'block';
    addEmployeeRow();
  };
</script>
</body>
</html>